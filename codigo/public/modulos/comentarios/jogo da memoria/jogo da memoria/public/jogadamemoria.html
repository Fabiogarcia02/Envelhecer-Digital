<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jogo da Mem√≥ria</title>
  <link rel="stylesheet" href="style.css" />

</head>
<body>
  <div class="container">
    <h1>Jogo da Mem√≥ria</h1>

    <p id="timer">Tempo restante: 04:00</p>

    <div>
      <label for="nome">Digite seu nome:</label>
      <input type="text" id="nome" placeholder="Seu nome" />
      <button onclick="salvarPontuacao()">Salvar Pontua√ß√£o</button>
    </div>

    <p id="score">Pontos: 0</p>
    <p id="melhor-pontuacao">Melhor pontua√ß√£o: 0</p>

    <div id="game-board" class="game-board"></div>

    <h2>Ranking</h2>
    <div id="ranking">Carregando...</div>
  </div>

  <!-- Sons de acerto e erro -->
  <audio id="success-sound" src="sounds/acerto.mp3"></audio>
  <audio id="error-sound" src="sounds/erro.mp3"></audio>

  <!-- M√∫sica de fundo -->
  <audio id="background-music" src="sounds/musica-fundo.mp3" loop></audio>
  <button id="toggle-music">üîà M√∫sica</button>

  <script>
    // M√∫sica de fundo e bot√£o toggle
    const backgroundMusic = document.getElementById("background-music");
    const toggleButton = document.getElementById("toggle-music");

    window.addEventListener("DOMContentLoaded", () => {
      backgroundMusic.volume = 0.2;
      backgroundMusic.play().catch(() => {
        // Navegadores podem bloquear autoplay
      });

      carregarRanking();
      carregarCartas()
    });

    toggleButton.addEventListener("click", () => {
      if (backgroundMusic.paused) {
        backgroundMusic.play();
        toggleButton.textContent = "üîà M√∫sica";
      } else {
        backgroundMusic.pause();
        toggleButton.textContent = "üîá M√∫sica";
      }
    });

    // Vari√°veis e elementos do jogo
    let gameBoard = document.getElementById("game-board");
    let successSound = document.getElementById("success-sound");
    let errorSound = document.getElementById("error-sound");
    let score = 0;
    let bestScore = Number(localStorage.getItem("bestScore")) || 0;
    document.getElementById("melhor-pontuacao").innerText = `Melhor pontua√ß√£o: ${bestScore}`;
    let firstCard = null;
    let lock = false;
    let timerInterval;

    // Fun√ß√£o para carregar ranking do backend
    async function carregarRanking() {
      try {
        const res = await fetch("http://localhost:3000/ranking");
        const data = await res.json();
        const rankingDiv = document.getElementById("ranking");

        if (!data.length) {
          rankingDiv.innerText = "Nenhuma pontua√ß√£o registrada ainda.";
          return;
        }

        const bestScoreLocal = localStorage.getItem("bestScore") || 0;
        let rankingHTML = data.map((item, i) =>
          `<p>${i + 1}. ${item.nome} - ${item.pontuacao} pontos</p>`
        ).join("");
        rankingHTML += `<p><strong>Melhor pontua√ß√£o local:</strong> ${bestScoreLocal}</p>`;

        rankingDiv.innerHTML = rankingHTML;
      } catch (err) {
        console.error("Erro ao carregar ranking:", err);
        document.getElementById("ranking").innerText = "Erro ao carregar ranking.";
      }
    }

    // Fun√ß√£o para carregar cartas do backend
    async function carregarCartas() {
      try {
        const res = await fetch("http://localhost:3000/cartas");
        const data = await res.json();

        // Cada carta cria um par: imagem + texto
        const cardsData = data.flatMap(item => [
          { type: "img", content: item.imagem, pairId: item.id  },
          { type: "text", content: item.descricao, pairId: item.id }
        ]);

        score = 0;
        document.getElementById("score").innerText = `Pontos: ${score}`;
        gameBoard.innerHTML = "";
        renderCards(cardsData);
        startTimer(240);
      } catch (err) {
        console.error("Erro ao carregar cartas:", err);
        alert("Erro ao carregar cartas do jogo.");
      }
    }

    function createCard(card, index, cardsData) {
      const div = document.createElement("div");
      div.classList.add("card");
      div.dataset.pairId = card.pairId;
      div.dataset.type = card.type;
      div.dataset.index = index;
      div.innerHTML = "";
      div.addEventListener("click", e => handleCardClick(e, cardsData));
      return div;
    }

    function renderCards(cardsData) {
      let shuffled = cardsData.sort(() => 0.5 - Math.random());
      gameBoard.innerHTML = "";
      shuffled.forEach((card, index) => {
        let cardElement = createCard(card, index, shuffled);
        gameBoard.appendChild(cardElement);
      });
    }

function handleCardClick(e, cardsData) {
  if (lock) return;
  let card = e.currentTarget;
  if (card.classList.contains("flipped") || card.classList.contains("matched")) return;

  let index = card.dataset.index;
  let cardData = cardsData[index];

  // Limpa antes para evitar bug ao virar
  card.innerHTML = "";
  card.classList.add("flipped");

  if (cardData.type === "img") {
    card.innerHTML = `<img src="${cardData.content}" style="max-width: 90%; max-height: 90%;">`;
  } else {
    card.innerText = cardData.content;
  }

  if (!firstCard) {
    firstCard = card;
  } else {
    lock = true;
    setTimeout(() => {
      let firstId = firstCard.dataset.pairId;
      let secondId = card.dataset.pairId;

      let firstType = firstCard.dataset.type;
      let secondType = card.dataset.type;

      console.log("Comparando pares:", { firstId, firstType, secondId, secondType });

      if (
        String(firstId) === String(secondId) && // Mesmo parId
        firstType !== secondType // Tipos diferentes (img vs text)
      ) {
        successSound.play();
        firstCard.classList.add("matched");
        card.classList.add("matched");
        score++;
        document.getElementById("score").innerText = `Pontos: ${score}`;
        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem("bestScore", bestScore);
          document.getElementById("melhor-pontuacao").innerText = `Melhor pontua√ß√£o: ${bestScore}`;
          carregarRanking();
        }
      } else {
        errorSound.play();
        firstCard.classList.remove("flipped");
        card.classList.remove("flipped");
        firstCard.innerHTML = "";
        card.innerHTML = "";
      }

      firstCard = null;
      lock = false;
    }, 1000);
  }
}


    function startTimer(duration) {
      let timerDisplay = document.getElementById("timer");
      let time = duration;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        let minutes = String(Math.floor(time / 60)).padStart(2, "0");
        let seconds = String(time % 60).padStart(2, "0");
        timerDisplay.innerText = `Tempo restante: ${minutes}:${seconds}`;
        if (time <= 0) {
          clearInterval(timerInterval);
          alert("Tempo esgotado! Sua pontua√ß√£o foi: " + score);
        }
        time--;
      }, 1000);
    }

    // Fun√ß√£o para salvar pontua√ß√£o no backend
    function salvarPontuacao() {
      const nome = document.getElementById("nome").value.trim();
      if (!nome) {
        alert("Digite seu nome antes de salvar a pontua√ß√£o.");
        return;
      }

      fetch("http://localhost:3000/ranking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, pontuacao: score }),
      })
      .then(res => {
        if (!res.ok) throw new Error("Erro ao salvar pontua√ß√£o");
        alert("Pontua√ß√£o salva com sucesso!");
        carregarRanking();
      })
      .catch(err => {
        console.error("Erro:", err);
        alert("N√£o foi poss√≠vel salvar a pontua√ß√£o.");
      });
    }
  </script>
</body>
</html>
